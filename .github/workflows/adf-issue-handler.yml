name: ADF Issue Handler

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  process-issue:
    name: Process Issue
    if: |
      (
        github.event_name == 'issues' && github.event.action == 'opened' && 
        contains(toJson(github.event.issue.labels.*.name), 'adf')
      ) || (
        github.event_name == 'issue_comment' && contains(github.event.comment.body, 'adf') && 
        contains(toJson(github.event.issue.labels.*.name), 'adf')
      )
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: requirements-adf.txt

      - name: Install Python dependencies
        run: pip install -r requirements-adf.txt

      - name: Install GitHub CLI
        run: |
          type -p wget >/dev/null || (sudo apt update && sudo apt-get install wget -y)
          sudo mkdir -p -m 755 /etc/apt/keyrings
          wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null
          sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Configure Git
        run: |
          git config --global user.name "adf-bot"
          git config --global user.email "adf-bot@users.noreply.github.com"

      - name: Run ADF Orchestrator
        id: adf
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Running ADF orchestrator for issue #${{ github.event.issue.number }}"
          python -m adf.adf_orchestrator ${{ github.event.issue.number }}

      - name: Comment on Success
        if: success()
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "âœ… **ADF Workflow Completed Successfully**
          
          The automated development workflow has finished processing this issue.
          
          - ðŸ”— [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - ðŸ“‹ Check the comments above for detailed progress
          - ðŸ” Review the generated PR (if applicable)
          
          ---
          *Triggered by: @${{ github.actor }}*"

      - name: Comment on Failure
        if: failure()
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "âŒ **ADF Workflow Failed**
          
          The automated development workflow encountered an error while processing this issue.
          
          **Next Steps:**
          1. ðŸ”— [Check the workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details
          2. ðŸ“¥ Download the artifact logs from the workflow run
          3. ðŸ”§ Fix any issues and try again with a new comment containing 'adf'
          
          **Common Issues:**
          - Missing or invalid \`ANTHROPIC_API_KEY\`
          - GitHub CLI authentication problems
          - Invalid issue format or missing information
          
          ---
          *Triggered by: @${{ github.actor }}*"

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: adf-logs-${{ github.run_id }}
          path: |
            agents/
            specs/
            adf-logs/
          retention-days: 7

      - name: Cleanup on Failure
        if: failure()
        run: |
          echo "Cleaning up resources..."
          
          # Get current branch (if created)
          CURRENT_BRANCH=$(git branch --show-current)
          
          # If we're not on main/master, try to clean up
          if [[ "$CURRENT_BRANCH" != "main" && "$CURRENT_BRANCH" != "master" ]]; then
            echo "Attempting to clean up branch: $CURRENT_BRANCH"
            
            # Switch back to main
            git checkout main 2>/dev/null || git checkout master 2>/dev/null || true
            
            # Delete the branch locally if it exists
            git branch -D "$CURRENT_BRANCH" 2>/dev/null || true
            
            # Delete remote branch if it was pushed
            git push origin --delete "$CURRENT_BRANCH" 2>/dev/null || true
            
            echo "Cleanup completed"
          else
            echo "No cleanup needed - on main branch"
          fi